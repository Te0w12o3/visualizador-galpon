<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Depósito - EBM Papst</title>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        #root { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const ChevronLeft = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        );

        const ChevronRight = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        );

        const Package = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
        );

        const WarehouseFloorPlan = () => {
            const [currentLayer, setCurrentLayer] = useState(1);
            const [selectedLocation, setSelectedLocation] = useState(null);
            const [inventory, setInventory] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [searchResults, setSearchResults] = useState(null);
            const [highlightedLocation, setHighlightedLocation] = useState(null);

            const handleFileSelect = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    
                    Papa.parse(text, {
                        complete: (results) => {
                            const dataRows = results.data.slice(8);
                            
                            const parsedData = dataRows
                                .filter(row => row[0] && row[0].trim() !== '')
                                .map(row => ({
                                    codigo: row[0]?.trim() || '',
                                    descripcion: row[2]?.trim() || '',
                                    stock: parseInt(row[3]) || 0,
                                    ubicacion: row[4]?.trim() || ''
                                }))
                                .filter(item => item.codigo && item.ubicacion);
                            
                            setInventory(parsedData);
                            setIsLoading(false);
                            console.log(`✅ Cargados ${parsedData.length} productos`);
                        },
                        error: (error) => {
                            console.error('Error al parsear CSV:', error);
                            alert('Error al leer el CSV: ' + error.message);
                        }
                    });
                };
                reader.readAsText(file);
            };

            const layerConfigs = {
                1: {
                    name: "Capa 1 - Piso",
                    racks: [
                        { name: 'A', x: 50, y: 150, levels: 14, width: 140, height: 500 },
                        { name: 'c', x: 250, y: 150, levels: 10, width: 140, height: 360 },
                        { name: 'C', x: 410, y: 150, levels: 10, width: 140, height: 360 },
                        { name: 'F', x: 650, y: 150, levels: 13, width: 140, height: 470 }
                    ]
                },
                2: {
                    name: "Capa 2 - Segunda Fila",
                    racks: [
                        { name: 'B', x: 50, y: 150, levels: 14, width: 140, height: 500 },
                        { name: 'd', x: 250, y: 150, levels: 10, width: 140, height: 360 },
                        { name: 'D', x: 410, y: 150, levels: 10, width: 140, height: 360 },
                        { name: 'G', x: 650, y: 150, levels: 13, width: 140, height: 470 }
                    ]
                },
                3: {
                    name: "Capa 3 - Tercera Fila (Arriba)",
                    racks: [
                        { name: 'e', x: 250, y: 150, levels: 10, width: 140, height: 360 },
                        { name: 'E', x: 410, y: 150, levels: 10, width: 140, height: 360 },
                        { name: 'H', x: 650, y: 150, levels: 13, width: 140, height: 470 }
                    ]
                }
            };

            const parseLocations = (ubicacionStr) => {
                if (!ubicacionStr) return [];
                
                const locations = [];
                const parts = ubicacionStr.split(/\s*-\s*/);
                
                parts.forEach(part => {
                    const cleaned = part.trim();
                    // Mantener mayúsculas y minúsculas
                    const match = cleaned.match(/([a-zA-Z])(\d+)([abcABC]+)?/);
                    
                    if (match) {
                        const rack = match[1]; // Mantener mayúscula/minúscula original
                        const level = parseInt(match[2]);
                        const subPositions = match[3] ? match[3].toLowerCase().split('') : [];
                        
                        if (subPositions.length === 0) {
                            locations.push({ rack, level, subPosition: 'a' });
                            locations.push({ rack, level, subPosition: 'b' });
                            locations.push({ rack, level, subPosition: 'c' });
                        } else {
                            subPositions.forEach(sub => {
                                locations.push({ rack, level, subPosition: sub });
                            });
                        }
                    }
                });
                
                return locations;
            };

            const getItemsForLocation = (rackName, level, subPosition) => {
                return inventory.filter(item => {
                    const locations = parseLocations(item.ubicacion);
                    return locations.some(loc => 
                        loc.rack === rackName && // Comparación exacta respetando mayúsculas
                        loc.level === level &&
                        loc.subPosition === subPosition
                    );
                });
            };

            const getTotalStockInLocation = (rackName, level, subPosition) => {
                const items = getItemsForLocation(rackName, level, subPosition);
                return items.reduce((sum, item) => sum + item.stock, 0);
            };

            const getStockColor = (stock, isHighlighted) => {
                if (isHighlighted) return '#217fbd';
                if (stock === 0) return '#f5f5f5';
                if (stock < 50) return '#fff9c4';
                if (stock < 500) return '#ffeb3b';
                if (stock < 2000) return '#ffc107';
                return '#ff9800';
            };

            const handleLocationClick = (rackName, level, subPosition) => {
                const items = getItemsForLocation(rackName, level, subPosition);
                setSelectedLocation({ rack: rackName, level, subPosition, items });
                setSearchResults(null);
                setSearchTerm('');
                setHighlightedLocation(null);
            };

            const handleSearch = () => {
                if (!searchTerm.trim()) return;
                
                const results = inventory.filter(item => 
                    item.codigo.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                if (results.length > 0) {
                    // Obtener todas las ubicaciones únicas
                    const allLocations = [];
                    results.forEach(item => {
                        const locs = parseLocations(item.ubicacion);
                        locs.forEach(loc => {
                            allLocations.push({
                                ...loc,
                                item: item
                            });
                        });
                    });
                    
                    setSearchResults({ items: results, locations: allLocations });
                    setSelectedLocation(null);
                } else {
                    alert('No se encontraron productos con ese código');
                }
            };

            const goToLocation = (location) => {
                // Determinar en qué capa está el rack
                let targetLayer = 1;
                const rackUpper = location.rack.toUpperCase();
                if (['B', 'D', 'G'].includes(rackUpper)) targetLayer = 2;
                if (['E', 'H'].includes(rackUpper)) targetLayer = 3;
                // Para minúsculas
                if (['d'].includes(location.rack)) targetLayer = 2;
                if (['e'].includes(location.rack)) targetLayer = 3;
                
                setCurrentLayer(targetLayer);
                setHighlightedLocation({ 
                    rack: location.rack, 
                    level: location.level, 
                    subPosition: location.subPosition 
                });
                
                // Mostrar los items de esa ubicación
                const items = getItemsForLocation(location.rack, location.level, location.subPosition);
                setSelectedLocation({ 
                    rack: location.rack, 
                    level: location.level, 
                    subPosition: location.subPosition, 
                    items 
                });
                setSearchResults(null);
            };

            const currentConfig = layerConfigs[currentLayer];

            if (isLoading) {
                return (
                    <div style={{ 
                        width: '100vw', 
                        height: '100vh', 
                        display: 'flex', 
                        alignItems: 'center', 
                        justifyContent: 'center', 
                        backgroundColor: '#f3f4f6',
                        flexDirection: 'column',
                        gap: '20px'
                    }}>
                        <div style={{ textAlign: 'center', padding: '40px', backgroundColor: 'white', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)' }}>
                            <Package size={64} />
                            <h2 style={{ fontSize: '28px', marginTop: '20px', marginBottom: '10px', color: '#1f2937' }}>
                                Visualizador de Depósito
                            </h2>
                            <p style={{ fontSize: '16px', color: '#6b7280', marginBottom: '30px' }}>
                                Seleccioná el archivo CSV para empezar
                            </p>
                            <input 
                                type="file" 
                                accept=".csv" 
                                onChange={handleFileSelect}
                                style={{ 
                                    padding: '12px 24px', 
                                    fontSize: '16px',
                                    border: '2px solid #2563eb',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    backgroundColor: '#eff6ff'
                                }}
                            />
                            <p style={{ fontSize: '12px', color: '#9ca3af', marginTop: '15px' }}>
                                Archivo esperado: Stock EBMPapst - Ubicaciones.csv
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full h-screen bg-gray-50 flex flex-col">
                    <div className="bg-white p-4 shadow-lg flex items-center justify-between border-b">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcREVqEmgrYQWkkTsWgTFvCb2e3hSX_NKEp7YZc6LUn_avNqHnkvsMW_g5FONQDYLzP-YA&usqp=CAU" alt="ebm papst" style={{ height: '40px' }} />
                        
                        <div className="flex items-center gap-3">
                            <input
                                type="text"
                                placeholder="Buscar por código..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                                className="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                style={{ width: '300px' }}
                            />
                            <button
                                onClick={handleSearch}
                                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                            >
                                Buscar
                            </button>
                        </div>
                        
                        <div className="text-sm text-gray-600">
                            {inventory.length} productos cargados
                        </div>
                    </div>

                    <div className="flex-1 flex overflow-hidden">
                        <div className="flex-1 flex flex-col">
                            <div className="bg-white border-b p-4 flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <button
                                        onClick={() => setCurrentLayer(Math.max(1, currentLayer - 1))}
                                        disabled={currentLayer === 1}
                                        className="p-2 rounded bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        <ChevronLeft />
                                    </button>
                                    
                                    <div className="flex gap-2">
                                        {[1, 2, 3].map(layer => (
                                            <button
                                                key={layer}
                                                onClick={() => setCurrentLayer(layer)}
                                                className={`px-6 py-2 rounded font-semibold transition-colors ${
                                                    currentLayer === layer
                                                        ? 'bg-blue-600 text-white'
                                                        : 'bg-gray-200 hover:bg-gray-300'
                                                }`}
                                            >
                                                Capa {layer}
                                            </button>
                                        ))}
                                    </div>

                                    <button
                                        onClick={() => setCurrentLayer(Math.min(3, currentLayer + 1))}
                                        disabled={currentLayer === 3}
                                        className="p-2 rounded bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        <ChevronRight />
                                    </button>
                                </div>

                                <div className="text-lg font-semibold text-gray-700">
                                    {currentConfig.name}
                                </div>
                            </div>

                            <div className="flex-1 p-8 overflow-auto bg-gray-100">
                                <svg width="900" height="750" className="bg-white rounded-lg shadow-lg mx-auto">
                                    <text x="450" y="40" textAnchor="middle" className="text-xl font-bold fill-gray-700">
                                        {currentConfig.name}
                                    </text>

                                    {currentConfig.racks.map(rack => {
                                        const levelHeight = rack.height / rack.levels;
                                        const subWidth = rack.width / 3;
                                        
                                        return (
                                            <g key={rack.name}>
                                                <rect
                                                    x={rack.x}
                                                    y={rack.y}
                                                    width={rack.width}
                                                    height={rack.height}
                                                    fill="none"
                                                    stroke="#333"
                                                    strokeWidth="3"
                                                />
                                                
                                                <text
                                                    x={rack.x + rack.width / 2}
                                                    y={rack.y - 15}
                                                    textAnchor="middle"
                                                    style={{ fontSize: '24px', fontWeight: 'bold', fill: '#1f2937' }}
                                                >
                                                    {rack.name}
                                                </text>

                                                <text x={rack.x + subWidth * 0.5} y={rack.y - 3} textAnchor="middle" style={{ fontSize: '11px', fontWeight: '600', fill: '#4b5563' }}>A</text>
                                                <text x={rack.x + subWidth * 1.5} y={rack.y - 3} textAnchor="middle" style={{ fontSize: '11px', fontWeight: '600', fill: '#4b5563' }}>B</text>
                                                <text x={rack.x + subWidth * 2.5} y={rack.y - 3} textAnchor="middle" style={{ fontSize: '11px', fontWeight: '600', fill: '#4b5563' }}>C</text>

                                                {Array.from({ length: rack.levels }, (_, i) => {
                                                    const level = i + 1;
                                                    
                                                    return (
                                                        <g key={level}>
                                                            <line
                                                                x1={rack.x}
                                                                y1={rack.y + i * levelHeight}
                                                                x2={rack.x + rack.width}
                                                                y2={rack.y + i * levelHeight}
                                                                stroke="#666"
                                                                strokeWidth="1"
                                                            />
                                                            
                                                            {['a', 'b', 'c'].map((subPos, subIdx) => {
                                                                const items = getItemsForLocation(rack.name, level, subPos);
                                                                const totalStock = getTotalStockInLocation(rack.name, level, subPos);
                                                                const isHighlighted = highlightedLocation && 
                                                                    highlightedLocation.rack === rack.name && 
                                                                    highlightedLocation.level === level && 
                                                                    highlightedLocation.subPosition === subPos;
                                                                
                                                                return (
                                                                    <g key={subPos}>
                                                                        {subIdx > 0 && (
                                                                            <line
                                                                                x1={rack.x + subIdx * subWidth}
                                                                                y1={rack.y + i * levelHeight}
                                                                                x2={rack.x + subIdx * subWidth}
                                                                                y2={rack.y + (i + 1) * levelHeight}
                                                                                stroke="#999"
                                                                                strokeWidth="1"
                                                                                strokeDasharray="2,2"
                                                                            />
                                                                        )}
                                                                        
                                                                        <rect
                                                                            x={rack.x + subIdx * subWidth}
                                                                            y={rack.y + i * levelHeight}
                                                                            width={subWidth}
                                                                            height={levelHeight}
                                                                            fill={getStockColor(totalStock, isHighlighted)}
                                                                            fillOpacity={isHighlighted ? "1" : "0.8"}
                                                                            stroke={isHighlighted ? "#217fbd" : "none"}
                                                                            strokeWidth={isHighlighted ? "3" : "0"}
                                                                            style={{ cursor: 'pointer' }}
                                                                            onClick={() => handleLocationClick(rack.name, level, subPos)}
                                                                        />
                                                                        
                                                                        {items.length > 0 && (
                                                                            <text
                                                                                x={rack.x + subIdx * subWidth + subWidth / 2}
                                                                                y={rack.y + i * levelHeight + levelHeight / 2 + 4}
                                                                                textAnchor="middle"
                                                                                style={{ fontSize: '11px', fontWeight: 'bold', fill: isHighlighted ? '#ffffff' : '#b91c1c', pointerEvents: 'none' }}
                                                                            >
                                                                                {items.length}
                                                                            </text>
                                                                        )}
                                                                    </g>
                                                                );
                                                            })}
                                                            
                                                            <text
                                                                x={rack.x - 8}
                                                                y={rack.y + i * levelHeight + levelHeight / 2 + 4}
                                                                textAnchor="end"
                                                                style={{ fontSize: '13px', fontWeight: '600', fill: '#374151', pointerEvents: 'none' }}
                                                            >
                                                                {level}
                                                            </text>
                                                        </g>
                                                    );
                                                })}
                                            </g>
                                        );
                                    })}

                                    <g transform="translate(50, 680)">
                                        <text x="0" y="0" style={{ fontSize: '13px', fontWeight: '600', fill: '#374151' }}>Stock por ubicación:</text>
                                        <rect x="0" y="10" width="35" height="18" fill="#f5f5f5" stroke="#999" />
                                        <text x="40" y="24" style={{ fontSize: '11px', fill: '#4b5563' }}>Vacío</text>
                                        
                                        <rect x="100" y="10" width="35" height="18" fill="#fff9c4" stroke="#999" />
                                        <text x="140" y="24" style={{ fontSize: '11px', fill: '#4b5563' }}>&lt;50</text>
                                        
                                        <rect x="200" y="10" width="35" height="18" fill="#ffeb3b" stroke="#999" />
                                        <text x="240" y="24" style={{ fontSize: '11px', fill: '#4b5563' }}>50-499</text>
                                        
                                        <rect x="320" y="10" width="35" height="18" fill="#ffc107" stroke="#999" />
                                        <text x="360" y="24" style={{ fontSize: '11px', fill: '#4b5563' }}>500-1999</text>
                                        
                                        <rect x="460" y="10" width="35" height="18" fill="#ff9800" stroke="#999" />
                                        <text x="500" y="24" style={{ fontSize: '11px', fill: '#4b5563' }}>&gt;2000</text>
                                    </g>
                                </svg>
                            </div>
                        </div>

                        <div className="w-96 bg-white border-l shadow-lg overflow-y-auto">
                            <div className="p-4 border-b bg-gray-50">
                                <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                    <Package size={20} />
                                    {searchResults ? 'Resultados de Búsqueda' : 'Detalles de Ubicación'}
                                </h2>
                            </div>

                            {searchResults ? (
                                <div className="p-4">
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                                        <div className="text-sm text-gray-600">Producto encontrado:</div>
                                        <div className="text-lg font-bold text-blue-600">
                                            {searchResults.items[0].codigo}
                                        </div>
                                        <div className="text-sm text-gray-700 mt-1">
                                            {searchResults.items[0].descripcion}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">
                                            Stock total: {searchResults.items[0].stock.toLocaleString()}
                                        </div>
                                    </div>

                                    <div className="text-sm font-semibold text-gray-700 mb-2">
                                        Ubicaciones ({searchResults.locations.length}):
                                    </div>

                                    <div className="space-y-2">
                                        {searchResults.locations.map((loc, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => goToLocation(loc)}
                                                className="w-full text-left border rounded-lg p-3 hover:bg-blue-50 hover:border-blue-400 transition-colors"
                                            >
                                                <div className="font-bold text-blue-600 text-lg">
                                                    {loc.rack.toUpperCase()}{loc.level}{loc.subPosition.toUpperCase()}
                                                </div>
                                                <div className="text-xs text-gray-500 mt-1">
                                                    Click para ir a esta ubicación
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ) : selectedLocation ? (
                                <div className="p-4">
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                                        <div className="text-sm text-gray-600">Ubicación seleccionada:</div>
                                        <div className="text-2xl font-bold text-blue-600">
                                            {selectedLocation.rack.toUpperCase()}{selectedLocation.level}{selectedLocation.subPosition.toUpperCase()}
                                        </div>
                                        <div className="text-sm text-gray-600 mt-1">
                                            {selectedLocation.items.length} producto(s)
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">
                                            Stock total: {getTotalStockInLocation(selectedLocation.rack, selectedLocation.level, selectedLocation.subPosition).toLocaleString()}
                                        </div>
                                    </div>

                                    {selectedLocation.items.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500">
                                            <Package size={48} />
                                            <p>Ubicación vacía</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {selectedLocation.items.map((item, idx) => (
                                                <div key={idx} className="border rounded-lg p-3 hover:bg-gray-50 transition-colors">
                                                    <div className="font-mono text-xs text-blue-600 mb-1">
                                                        {item.codigo}
                                                    </div>
                                                    <div className="text-sm text-gray-800 font-medium mb-2">
                                                        {item.descripcion}
                                                    </div>
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-xs text-gray-500">Stock:</span>
                                                        <span className="font-bold text-lg text-orange-600">
                                                            {item.stock.toLocaleString()}
                                                        </span>
                                                    </div>
                                                    <div className="text-xs text-gray-400 mt-1 border-t pt-1">
                                                        {item.ubicacion}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="p-8 text-center text-gray-500">
                                    <Package size={64} />
                                    <p className="text-lg font-semibold">Seleccioná una ubicación</p>
                                    <p className="text-sm mt-2">Hacé clic en cualquier celda para ver los productos</p>
                                    <div className="mt-4 text-xs text-gray-400">
                                        <p>Cada nivel se divide en 3 sub-posiciones: A, B, C</p>
                                        <p className="mt-1">Los números indican cantidad de productos</p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(React.createElement(WarehouseFloorPlan));
    </script>
</body>
</html>